#!/usr/bin/env stap
global latency,time_spent;
probe process(@1).function("*") 
{
	printf("%s -> %s\n", thread_indent(1), probefunc()) 
} 

probe process(@1).function("*").return 
{
	printf("%s <- %s \n", thread_indent(-1), probefunc());
	latency[ppfunc()] <<< (gettimeofday_ns() - @entry(gettimeofday_ns()))
}

probe end,error {
	foreach (fn_name in latency){
		time_spent[fn_name] = @sum(latency[fn_name]);
	}
	foreach (fn_name in time_spent-){
		printf("%s %d\n", fn_name, time_spent[fn_name]);
	}

}
